#!/bin/bash

POKEMONS=("bulbasaur" "ivysaur" "venusaur" "charmander" "charmeleon")
OUTPUT_DIR="pokemon_data_parallel"
ERROR_LOG="errors.txt"

mkdir -p "$OUTPUT_DIR"

fetch_pokemon() {
    name=$1
    url="https://pokeapi.co/api/v2/pokemon/$name"
    output_file="$OUTPUT_DIR/${name}.json"
    retries=0
    success=0

    while [ $retries -lt 3 ]; do
        response=$(curl -s -w "%{http_code}" -o "$output_file" "$url")
        if [ "$response" -eq 200 ]; then
            echo "Saved data to $output_file ✓"
            success=1
            break
        else
            retries=$((retries + 1))
            echo "Attempt $retries failed for $name, retrying..."
            sleep 2
        fi
    done

    if [ $success -eq 0 ]; then
        echo "Failed to fetch $name after 3 attempts" >> "$ERROR_LOG"
        rm -f "$output_file"
    fi
}

PIDS=()

# Launch background jobs
for name in "${POKEMONS[@]}"; do
    fetch_pokemon "$name" &
    pid=$!
    echo "Started fetch for $name (PID $pid)"
    PIDS+=($pid)
done

# List jobs
echo "Currently running background jobs:"
jobs

# Wait for all jobs
for pid in "${PIDS[@]}"; do
    wait "$pid" || {
        echo "Job $pid failed or hung, killing it..."
        kill -9 "$pid" 2>/dev/null
    }
done

echo "All Pokémon data fetched in parallel."
